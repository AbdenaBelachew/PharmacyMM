@model IEnumerable<PharmacyMM.Models.Medicine>
@{
    ViewBag.Title = "Medicines Management";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/plugins/popper/popper.min.js"></script>
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        min-height: 100vh;
    }

    .modal-content {
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.3s ease-in-out;
        border: none;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal-header {
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        color: #fff;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
        padding: 1.5rem;
    }

    .modal-title {
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .modal-body {
        padding: 2rem;
        background: #fff;
    }

    .modal-footer {
        border-top: 1px solid #e9ecef;
        padding: 1rem 2rem;
        background: #f8f9fa;
        border-bottom-left-radius: 15px;
        border-bottom-right-radius: 15px;
    }

    .form-label {
        font-weight: 600;
        color: #343a40;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #ced4da;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
    }

    .btn {
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-primary, .btn-success, .btn-danger {
        padding: 0.5rem 1.5rem;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .btn-loading::after {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        margin-left: 8px;
        vertical-align: middle;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .table-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table th {
        background: linear-gradient(90deg, #343a40, #495057);
        color: #fff;
        font-weight: 600;
    }

    .table td {
        vertical-align: middle;
        transition: background-color 0.2s;
    }

    .table tbody tr:hover {
        background-color: #e9ecef;
    }

    .search-container {
        width: 100%;
        max-width: 600px;
        position: relative;
    }

    .search-container .form-control {
        padding-right: 2.5rem;
        border-radius: 8px;
    }

    .search-container .clear-search {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        display: none;
    }

    .search-container .clear-search:hover {
        color: #dc3545;
    }

    @@media (max-width: 576px) {
        .modal-dialog {
            margin: 1rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .search-container {
            max-width: 100%;
        }
    }
</style>

<div class="container mt-5">
    <h2 class="mb-4 text-primary fw-bold">Medicines Management</h2>

    <!-- Search Bar and Add Medicine Button -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mb-4 gap-3">
        <div class="search-container">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by name or category..." aria-label="Search medicines">
            <button type="button" class="clear-search" id="clearSearch" aria-label="Clear search">
                <i class="bi bi-x-circle"></i>
            </button>
        </div>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMedicineModal" data-bs-toggle="tooltip" title="Add a new medicine to the inventory">
            <i class="bi bi-plus-circle me-2"></i>Add New Medicine
        </button>
    </div>

    <!-- Medicines Table -->
    <div class="table-container p-3">
        <table class="table table-striped table-hover" id="medicineTable">
            <thead class="table-dark">
                <tr>
                    <th>Category</th>
                    <th>Name</th>
                    <th>Manufacturer</th>
                    <th>Quantity Left</th>
                    <th>Unit Price</th>
                    <th>Expiration Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var medicine in Model)
                {
                    <tr>
                        <td>@medicine.Category.CategoryName</td>
                        <td>@medicine.MedicineName</td>
                        <td>@medicine.Manufacturer</td>
                        <td>@medicine.StockQuantity</td>
                        <td>@String.Format("{0:C}", medicine.UnitPrice)</td>
                        <td>@medicine.ExpiryDate</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openEditModal(@medicine.MedicineID)" aria-label="Edit @medicine.MedicineName" data-bs-toggle="tooltip" title="Edit this medicine">
                                <i class="bi bi-pencil-square"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="openDeleteModal(@medicine.MedicineID, '@medicine.MedicineName')" aria-label="Delete @medicine.MedicineName" data-bs-toggle="tooltip" title="Delete this medicine">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Add Medicine Modal -->
<div class="modal fade" id="addMedicineModal" tabindex="-1" aria-labelledby="addMedicineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMedicineModalLabel">Add New Medicine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMedicineForm" novalidate>
                    @Html.AntiForgeryToken()
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="addCategoryID">Category</label>
                            @Html.DropDownList("CategoryID", ViewBag.CategoryID as SelectList, "Select Category", new { @class = "form-select", id = "addCategoryID", required = "required" })
                            <div class="error-message" id="addCategoryError">Please select a category.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="addMedicineName">Medicine Name</label>
                            <input type="text" id="addMedicineName" name="MedicineName" class="form-control" required aria-describedby="addNameError">
                            <div class="error-message" id="addNameError">Please enter a valid medicine name.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="addManufacturer">Manufacturer</label>
                            <input type="text" id="addManufacturer" name="Manufacturer" class="form-control" required aria-describedby="addManufacturerError">
                            <div class="error-message" id="addManufacturerError">Please enter a valid manufacturer.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="addUnitPrice">Unit Price</label>
                            <input type="number" id="addUnitPrice" name="UnitPrice" step="0.01" min="0" class="form-control" required aria-describedby="addPriceError">
                            <div class="error-message" id="addPriceError">Please enter a valid unit price.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="addStockQuantity">Quantity</label>
                            <input type="number" id="addStockQuantity" name="StockQuantity" min="0" class="form-control" required aria-describedby="addQuantityError">
                            <div class="error-message" id="addQuantityError">Please enter a valid quantity.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="addExpiryDate">Expiry Date</label>
                            <input type="date" id="addExpiryDate" name="ExpiryDate" class="form-control" required aria-describedby="addExpiryError">
                            <div class="error-message" id="addExpiryError">Please select a valid expiry date.</div>
                        </div>
                    </div>
                    <div class="error-message" id="addGeneralError">An error occurred while saving.</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addMedicineBtn" onclick="submitAddMedicine()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Medicine Modal -->
<div class="modal fade" id="editMedicineModal" tabindex="-1" aria-labelledby="editMedicineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMedicineModalLabel">Edit Medicine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMedicineForm" novalidate>
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="MedicineID" id="editMedicineID">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="editCategoryID">Category</label>
                            @Html.DropDownList("CategoryID", ViewBag.CategoryID as SelectList, "Select Category", new { @class = "form-select", id = "editCategoryID", required = "required" })
                            <div class="error-message" id="editCategoryError">Please select a category.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="editMedicineName">Medicine Name</label>
                            <input type="text" id="editMedicineName" name="MedicineName" class="form-control" required aria-describedby="editNameError">
                            <div class="error-message" id="editNameError">Please enter a valid medicine name.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="editManufacturer">Manufacturer</label>
                            <input type="text" id="editManufacturer" name="Manufacturer" class="form-control" required aria-describedby="editManufacturerError">
                            <div class="error-message" id="editManufacturerError">Please enter a valid manufacturer.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="editUnitPrice">Unit Price</label>
                            <input type="number" id="editUnitPrice" name="UnitPrice" step="0.01" min="0" class="form-control" required aria-describedby="editPriceError">
                            <div class="error-message" id="editPriceError">Please enter a valid unit price.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="editStockQuantity">Quantity</label>
                            <input type="number" id="editStockQuantity" name="StockQuantity" min="0" class="form-control" required aria-describedby="editQuantityError">
                            <div class="error-message" id="editQuantityError">Please enter a valid quantity.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label" for="editExpiryDate">Expiry Date</label>
                            <input type="date" id="editExpiryDate" name="ExpiryDate" class="form-control" required aria-describedby="editExpiryError">
                            <div class="error-message" id="editExpiryError">Please select a valid expiry date.</div>
                        </div>
                    </div>
                    <div class="error-message" id="editGeneralError">An error occurred while saving.</div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editMedicineBtn" onclick="submitEditMedicine()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Medicine Modal -->
<div class="modal fade" id="deleteMedicineModal" tabindex="-1" aria-labelledby="deleteMedicineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMedicineModalLabel">Delete Medicine</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <span id="deleteMedicineName" class="fw-bold"></span>?</p>
                <input type="hidden" id="deleteMedicineID">
                <div class="error-message" id="deleteGeneralError">An error occurred while deleting.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteMedicineBtn" onclick="submitDeleteMedicine()">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}

<script>
    // Initialize tooltips
    $(document).ready(function () {
        $('[data-bs-toggle="tooltip"]').tooltip();

        // Search functionality
        $('#searchInput').on('input', function () {
            const searchTerm = $(this).val().toLowerCase();
            const clearButton = $('#clearSearch');

            if (searchTerm.length > 0) {
                clearButton.show();
            } else {
                clearButton.hide();
            }

            $('#medicineTable tbody tr').each(function () {
                const name = $(this).find('td:eq(1)').text().toLowerCase();
                const category = $(this).find('td:eq(0)').text().toLowerCase();
                if (name.includes(searchTerm) || category.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $('#clearSearch').on('click', function () {
            $('#searchInput').val('').trigger('input');
        });
    });

    // Client-side form validation
    function validateForm(formId) {
        const form = document.getElementById(formId);
        const inputs = form.querySelectorAll('input[required], select[required]');
        let isValid = true;

        inputs.forEach(input => {
            const errorElement = document.getElementById(`${input.id}Error`);
            if (!input.checkValidity()) {
                isValid = false;
                input.classList.add('is-invalid');
                if (errorElement) errorElement.style.display = 'block';
            } else {
                input.classList.remove('is-invalid');
                if (errorElement) errorElement.style.display = 'none';
            }
        });

        return isValid;
    }

    function openEditModal(id) {
        $.get('@Url.Action("Edit", "Medicines")/' + id, function (data) {
            $('#editMedicineID').val(data.MedicineID);
            $('#editMedicineName').val(data.MedicineName);
            $('#editManufacturer').val(data.Manufacturer);
            $('#editUnitPrice').val(data.UnitPrice);
            $('#editStockQuantity').val(data.StockQuantity);
            $('#editCategoryID').val(data.CategoryID);
            $('#editExpiryDate').val(data.ExpiryDate ? new Date(data.ExpiryDate).toISOString().split('T')[0] : '');
            $('.error-message').hide();
            $('#editMedicineModal').modal('show');
        }).fail(function () {
            $('#editGeneralError').text('Error loading medicine data').show();
        });
    }

    function openDeleteModal(id, name) {
        $('#deleteMedicineID').val(id);
        $('#deleteMedicineName').text(name);
        $('#deleteGeneralError').hide();
        $('#deleteMedicineModal').modal('show');
    }

    function submitAddMedicine() {
        if (!validateForm('addMedicineForm')) return;

        const $btn = $('#addMedicineBtn');
        $btn.prop('disabled', true).addClass('btn-loading');

        $.ajax({
            url: '@Url.Action("Create", "Medicines")',
            type: 'POST',
            data: $('#addMedicineForm').serialize(),
            success: function (response) {
                if (response.success) {
                    $('#addMedicineModal').modal('hide');
                    location.reload();
                } else {
                    $('#addGeneralError').text(response.message || 'Error saving medicine').show();
                }
            },
            error: function () {
                $('#addGeneralError').text('Error saving medicine').show();
            },
            complete: function () {
                $btn.prop('disabled', false).removeClass('btn-loading');
            }
        });
    }

    function submitEditMedicine() {
        if (!validateForm('editMedicineForm')) return;

        const $btn = $('#editMedicineBtn');
        $btn.prop('disabled', true).addClass('btn-loading');

        $.ajax({
            url: '@Url.Action("Edit", "Medicines")',
            type: 'POST',
            data: $('#editMedicineForm').serialize(),
            success: function (response) {
                if (response.success) {
                    $('#editMedicineModal').modal('hide');
                    location.reload();
                } else {
                    $('#editGeneralError').text(response.message || 'Error saving changes').show();
                }
            },
            error: function () {
                $('#editGeneralError').text('Error saving changes').show();
            },
            complete: function () {
                $btn.prop('disabled', false).removeClass('btn-loading');
            }
        });
    }

    function submitDeleteMedicine() {
        const $btn = $('#deleteMedicineBtn');
        $btn.prop('disabled', true).addClass('btn-loading');

        $.ajax({
            url: '@Url.Action("DeleteConfirmed", "Medicines")',
            type: 'POST',
            data: {
                id: $('#deleteMedicineID').val(),
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    $('#deleteMedicineModal').modal('hide');
                    location.reload();
                } else {
                    $('#deleteGeneralError').text(response.message || 'Error deleting medicine').show();
                }
            },
            error: function () {
                $('#deleteGeneralError').text('Error deleting medicine').show();
            },
            complete: function () {
                $btn.prop('disabled', false).removeClass('btn-loading');
            }
        });
    }
</script>